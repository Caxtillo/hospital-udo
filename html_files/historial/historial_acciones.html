<!-- html_files/historial_acciones.html -->
<div class="p-6 md:p-8 h-full flex flex-col">

    <!-- Título y Controles (sin cambios significativos aquí, solo IDs verificados) -->
    <div class="flex flex-wrap justify-between items-center mb-6 pb-4 border-b border-gray-200 flex-shrink-0 gap-y-4 gap-x-3">
        <h2 class="text-2xl font-semibold text-teal-700 w-full md:w-auto">Historial de Acciones</h2>
         <span class="block text-xs text-gray-500 mt-1 md:ml-auto md:mr-3"> <!-- Ajuste de margen para que no choque con controles -->
            Presiona Espacio para abrir calendario
        </span>
        <div class="flex flex-wrap items-end gap-x-3 gap-y-4 w-full">
            <div class="flex-grow relative">
                <label for="general-search-input" class="block text-xs font-medium text-gray-600 mb-1">Buscar</label>
                <span class="absolute left-3 top-1/2 mt-2.5 transform -translate-y-1/2 text-gray-400 text-sm"><i class="fas fa-search"></i></span>
                <input type="text" id="general-search-input" placeholder="Buscar en historial..."
                    class="w-full pl-9 pr-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-teal-500 focus:border-teal-500 transition duration-150 h-[42px]">
            </div>
            <div class="flex-shrink-0">
                <label for="filter-date-start" class="block text-xs font-medium text-gray-600 mb-1">Desde</label>
                <input type="date" id="filter-date-start" title="Fecha Inicio"
                        class="w-full sm:w-auto text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-teal-500 focus:border-teal-500 transition duration-150 py-2 px-3 h-[42px]">
            </div>
            <div class="flex-shrink-0">
                <label for="filter-date-end" class="block text-xs font-medium text-gray-600 mb-1">Hasta</label>
                <input type="date" id="filter-date-end" title="Fecha Fin"
                    class="w-full sm:w-auto text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-teal-500 focus:border-teal-500 transition duration-150 py-2 px-3 h-[42px]">
            </div>
            <div class="flex space-x-2 pt-1 sm:pt-0 self-end flex-shrink-0">
                <button id="filter-button" title="Aplicar Filtros"
                        class="px-5 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-md shadow text-sm font-medium transition duration-150 h-[42px]">
                    <i class="fas fa-filter mr-1"></i> Filtrar
                </button>
                <button id="clear-filter-button" title="Limpiar Filtros"
                        class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md shadow text-sm font-medium transition duration-150 h-[42px]">
                    <i class="fas fa-times"></i> Limpiar
                </button>
            </div>
        </div>
    </div>

    
    <div id="historial-table-container" class="flex-grow overflow-auto rounded-lg border border-gray-200 shadow-md bg-white relative">
        <div id="historial-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500 italic bg-gray-50 z-10">Cargando historial...</div>
        <table class="min-w-full divide-y divide-gray-200 hidden">
             <thead class="bg-gray-100 sticky top-0 z-5">
                <tr>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b w-40">Fecha y Hora</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b w-48">Usuario (Actor)</th> 
                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b w-40">Tipo Acción</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b">Descripción Detallada</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b w-24">Tabla Afect.</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b w-20">ID Reg.</th>
                </tr>
            </thead>
            <tbody id="historial-table-body" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>

     
    <div id="historial-pagination" class="flex justify-between items-center pt-4 flex-shrink-0" style="display: none;">
        <span id="historial-pagination-info" class="text-sm text-gray-600"></span>
        <div class="space-x-2">
            <button id="historial-prev-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">Ant</button>
            <button id="historial-next-page" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">Sig</button>
        </div>
    </div>
</div>

<script>
    (function() {
        const SCRIPT_VIEW_NAME = 'historial__historial_acciones';
        console.log(`Ejecutando script de ${SCRIPT_VIEW_NAME}.html`);
    
        const searchInput = document.getElementById('general-search-input');
        const dateStartInput = document.getElementById('filter-date-start');
        const dateEndInput = document.getElementById('filter-date-end');
        const filterButton = document.getElementById('filter-button');
        const clearFilterButton = document.getElementById('clear-filter-button');
        const tableContainer = document.getElementById('historial-table-container');
        const table = tableContainer ? tableContainer.querySelector('table') : null;
        const tableBody = document.getElementById('historial-table-body');
        const placeholder = document.getElementById('historial-placeholder');
        const paginationControls = document.getElementById('historial-pagination');
        const paginationInfo = document.getElementById('historial-pagination-info');
        const prevButton = document.getElementById('historial-prev-page');
        const nextButton = document.getElementById('historial-next-page');
    
        let allLogs = [];
        let filteredLogs = [];
        let currentPage = 1;
        const itemsPerPage = 30;
    
        if (!table || !tableBody || !placeholder || !searchInput || !dateStartInput || !dateEndInput || !filterButton || !clearFilterButton || !paginationControls || !paginationInfo || !prevButton || !nextButton ) {
            console.error(`Error crítico en ${SCRIPT_VIEW_NAME}: Faltan elementos UI.`);
            if(placeholder) placeholder.textContent = "Error al cargar interfaz.";
            return;
        }
    
        function applyFiltersAndDisplay() {
            const generalSearchTerm = searchInput.value.toLowerCase().trim();
            const startDateStr = dateStartInput.value;
            const endDateStr = dateEndInput.value;
    
            let startDate = startDateStr ? new Date(startDateStr + 'T00:00:00') : null;
            let endDate = endDateStr ? new Date(endDateStr + 'T23:59:59') : null;
    
            filteredLogs = allLogs.filter(log => {
                let dateMatch = true;
                if (log.fecha_iso) { // fecha_iso es la fecha parseable que preprocesamos
                    const logDate = new Date(log.fecha_iso);
                    if (startDate && logDate < startDate) dateMatch = false;
                    if (endDate && logDate > endDate) dateMatch = false;
                } else if (startDate || endDate) { // Si hay filtro de fecha pero el log no tiene fecha parseable
                    dateMatch = false;
                }
    
                if (!dateMatch) return false;
                if (!generalSearchTerm) return true; // Si no hay término de búsqueda, solo se aplica el filtro de fecha
    
                // Buscar en campos relevantes, incluyendo los nuevos
                const actor = (log.actor_display_name || log.nombre_usuario || '').toLowerCase(); // Usuario que hizo la acción
                const tipoAccion = (log.tipo_accion || '').toLowerCase();
                const descEntendible = (log.descripcion_entendible || log.descripcion_original || '').toLowerCase(); // Nueva descripción
                const tabla = (log.tabla_afectada || '').toLowerCase();
                const regIdStr = log.registro_afectado_id !== null ? String(log.registro_afectado_id) : '';
                const fechaFormateada = (log.fecha_hora_formateada || '').toLowerCase();
    
                return (
                    actor.includes(generalSearchTerm) ||
                    tipoAccion.includes(generalSearchTerm) ||
                    descEntendible.includes(generalSearchTerm) ||
                    tabla.includes(generalSearchTerm) ||
                    regIdStr.includes(generalSearchTerm) ||
                    fechaFormateada.includes(generalSearchTerm)
                );
            });
    
            currentPage = 1;
            displayCurrentPage();
        }
    
        function displayCurrentPage() {
            if (!tableBody || !placeholder || !table || !paginationInfo || !prevButton || !nextButton || !paginationControls) return;
            tableBody.innerHTML = '';
            const totalFilteredItems = filteredLogs.length;
            const totalPages = Math.ceil(totalFilteredItems / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
            if (currentPage < 1 && totalFilteredItems > 0) currentPage = 1; // Corregido para evitar currentPage 0
            else if (totalFilteredItems === 0) currentPage = 1; // Resetear a 1 si no hay resultados

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredLogs.slice(startIndex, endIndex);
    
            if (totalFilteredItems === 0) {
                placeholder.textContent = allLogs.length === 0 ? 'No hay acciones registradas en el sistema.' : 'No hay acciones que coincidan con los filtros aplicados.';
                placeholder.classList.remove('hidden');
                table.classList.add('hidden');
                paginationControls.style.display = 'none';
            } else {
                placeholder.classList.add('hidden');
                table.classList.remove('hidden');
                pageItems.forEach(log => {
                    const row = tableBody.insertRow();
                    row.className = 'text-xs hover:bg-gray-50';
                    const tabla = log.tabla_afectada || '-';
                    const regId = log.registro_afectado_id !== null ? log.registro_afectado_id : '-';
                    
                    // Usar los nuevos campos para mostrar
                    const actorNombre = log.actor_display_name || log.nombre_usuario || `ID:${log.usuario_id}`;
                    const descripcionMostrada = log.descripcion_entendible || log.descripcion_original || '';

                    row.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap text-gray-600">${log.fecha_hora_formateada || log.fecha_hora}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-gray-700 font-medium">${actorNombre}</td>
                        <td class="px-4 py-2 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getTipoAccionColor(log.tipo_accion)}">
                                ${log.tipo_accion || '?'}
                            </span>
                        </td>
                        <td class="px-4 py-2 text-gray-800 break-words min-w-[200px] max-w-lg">${descripcionMostrada}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-gray-500">${tabla}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-gray-500 text-center">${regId}</td>
                    `;
                });
                updatePaginationControls(totalFilteredItems, totalPages);
            }
        }

        function getTipoAccionColor(tipoAccion) {
            if (!tipoAccion) return 'bg-gray-100 text-gray-800';
            const tipoLower = tipoAccion.toLowerCase();
            if (tipoLower.includes('crear') || tipoLower.includes('add')) return 'bg-green-100 text-green-800';
            if (tipoLower.includes('actualizar') || tipoLower.includes('update') || tipoLower.includes('edit')) return 'bg-blue-100 text-blue-800';
            if (tipoLower.includes('eliminar') || tipoLower.includes('delete') || tipoLower.includes('toggle_estado_usuario')) return 'bg-red-100 text-red-800'; // Asumiendo toggle a inactivo
            if (tipoLower.includes('login_exitoso')) return 'bg-emerald-100 text-emerald-800';
            if (tipoLower.includes('login_fallido')) return 'bg-amber-100 text-amber-800';
            if (tipoLower.includes('logout')) return 'bg-indigo-100 text-indigo-800';
            return 'bg-gray-100 text-gray-800';
        }
    
        function updatePaginationControls(totalItems, totalPg) {
             const startItemNum = totalItems > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
             const endItemNum = Math.min(currentPage * itemsPerPage, totalItems);
             if(paginationInfo) paginationInfo.textContent = `Mostrando ${startItemNum}-${endItemNum} de ${totalItems}`;
             if(prevButton) prevButton.disabled = (currentPage <= 1);
             if(nextButton) nextButton.disabled = (currentPage >= totalPg);
             if (paginationControls) paginationControls.style.display = totalItems > 0 ? 'flex' : 'none';
        }
    
        function fetchInitialLog() {
            if(placeholder) { placeholder.textContent = 'Cargando historial...'; placeholder.classList.remove('hidden'); }
            if(table) table.classList.add('hidden');
            if(paginationControls) paginationControls.style.display = 'none';
    
            const filters = {
                search_term: searchInput.value.trim(),
                fecha_desde: dateStartInput.value,
                fecha_hasta: dateEndInput.value
            };
            // Limpiar filtros si están vacíos para no enviar strings vacíos al backend
            if (!filters.search_term) delete filters.search_term;
            if (!filters.fecha_desde) delete filters.fecha_desde;
            if (!filters.fecha_hasta) delete filters.fecha_hasta;


            console.log(`${SCRIPT_VIEW_NAME}: Solicitando historial con filtros:`, filters);
            if (typeof backend !== 'undefined' && backend.request_action_log_with_filters) {
                 try {
                     // PASAR 'filters' Y 'currentPage'
                     backend.request_action_log_with_filters(filters, currentPage); 
                 }
                 catch(e) { console.error("Error llamando request_action_log_with_filters:", e); if(placeholder) placeholder.textContent = 'Error de comunicación.'; }
            } else { console.error("Backend o request_action_log_with_filters no disponible."); if(placeholder) placeholder.textContent = 'Error: No se puede conectar.'; }
        }
    
        filterButton.addEventListener('click', fetchInitialLog); // Ahora el filtro llama a fetch con los filtros actuales
    
        clearFilterButton.addEventListener('click', () => {
             searchInput.value = '';
             dateStartInput.value = '';
             dateEndInput.value = '';
             fetchInitialLog(); // Volver a cargar con filtros vacíos
        });
    
        [searchInput, dateStartInput, dateEndInput].forEach(input => {
            if(input) {
                input.addEventListener('keypress', (e) => { if (e.key === 'Enter') fetchInitialLog(); });
            }
        });
    
        prevButton.addEventListener('click', () => { if (currentPage > 1) { currentPage--; displayCurrentPage(); } });
        nextButton.addEventListener('click', () => { const totalPages = Math.ceil(filteredLogs.length / itemsPerPage); if (currentPage < totalPages) { currentPage++; displayCurrentPage(); } });
    
    
        window[`handleActionLogResult_${SCRIPT_VIEW_NAME}`]= function(logList, totalItemsServer) {
            console.log(`${SCRIPT_VIEW_NAME}: Recibidos ${logList ? logList.length : 0} logs del servidor (Total reportado por servidor: ${totalItemsServer}).`);
            if (logList === null || !Array.isArray(logList)) {
                 if(placeholder) placeholder.textContent = 'Error al cargar historial o datos inválidos.';
                 allLogs = [];
            } else {
                 allLogs = logList.map(log => {
                    try {
                        log.fecha_iso = new Date(log.fecha_hora).toISOString(); // Para ordenamiento y filtro de fecha confiable
                        // fecha_hora_formateada ya viene de Python
                    } catch(e) {
                        log.fecha_iso = null;
                    }
                    return log;
                });
                // No es necesario ordenar aquí si el backend ya lo hace con paginación
            }
            // Como el backend ahora hace el filtrado y paginación, filteredLogs es igual a allLogs (la página actual)
            filteredLogs = allLogs; 
            currentPage = 1; // Siempre mostramos la página 1 de los datos recibidos
            displayCurrentPage(); // Muestra los datos recibidos (que ya son la página actual)
            
            // Actualizar controles de paginación basados en totalItemsServer
            const totalPagesServer = Math.ceil(totalItemsServer / itemsPerPage);
            if(paginationInfo) paginationInfo.textContent = `Mostrando ${filteredLogs.length > 0 ? ( (currentPage-1)*itemsPerPage + 1 ) : 0}-${Math.min(currentPage * itemsPerPage, totalItemsServer)} de ${totalItemsServer}`;
            if(prevButton) prevButton.disabled = (currentPage <= 1); // Esto se ajustará con la lógica de paginación real
            if(nextButton) nextButton.disabled = (currentPage >= totalPagesServer || totalItemsServer <= itemsPerPage);
            if (paginationControls) paginationControls.style.display = totalItemsServer > 0 ? 'flex' : 'none';
        };
    
        // --- Carga inicial ---
        fetchInitialLog();
    
    })();
</script>